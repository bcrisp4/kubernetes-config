loki:
  deploymentMode: Distributed
  global:
    extraArgs:
      - -config.expand-env=true
    extraEnvFrom:
      - secretRef:
          name: s3-credentials
    # CSI driver volumes for mTLS certificates
    extraVolumes:
      - name: tls-certs
        csi:
          driver: csi.cert-manager.io
          readOnly: true
          volumeAttributes:
            csi.cert-manager.io/issuer-name: loki-ca-issuer
            csi.cert-manager.io/issuer-kind: Issuer
            csi.cert-manager.io/dns-names: "*.loki-headless.{{ .Release.Namespace }}.svc.cluster.local,*.loki.{{ .Release.Namespace }}.svc.cluster.local,loki.{{ .Release.Namespace }}.svc.cluster.local"
            csi.cert-manager.io/duration: 168h # 7 days
            csi.cert-manager.io/renew-before: 24h # Renew 1 day before expiry
            csi.cert-manager.io/key-algorithm: ECDSA
            csi.cert-manager.io/key-size: "256"
            csi.cert-manager.io/key-usages: "digital signature,key encipherment,server auth,client auth"
            csi.cert-manager.io/certificate-file: tls.crt
            csi.cert-manager.io/ca-file: ca.crt
            csi.cert-manager.io/privatekey-file: tls.key
    extraVolumeMounts:
      - name: tls-certs
        mountPath: /etc/loki/tls
        readOnly: true
  loki:
    revisionHistoryLimit: 0
    server:
      http_tls_config:
        cert_file: /etc/loki/tls/tls.crt
        key_file: /etc/loki/tls/tls.key
        client_ca_file: /etc/loki/tls/ca.crt
        client_auth_type: RequireAndVerifyClientCert
      grpc_tls_config:
        cert_file: /etc/loki/tls/tls.crt
        key_file: /etc/loki/tls/tls.key
        client_ca_file: /etc/loki/tls/ca.crt
        client_auth_type: RequireAndVerifyClientCert
    schemaConfig:
      configs:
        - from: 2024-04-01
          store: tsdb
          object_store: s3
          schema: v13
          index:
            prefix: loki_index_
            period: 24h
    ingester:
      chunk_encoding: snappy
    pattern_ingester:
      enabled: true
    limits_config:
      allow_structured_metadata: true
      volume_enabled: true
      retention_period: 672h # 28 days retention
    storage:
      type: s3
      bucketNames:
        chunks: bc4-loki-nbg1-prod1
        ruler: bc4-loki-nbg1-prod1
        admin: bc4-loki-nbg1-prod1
      s3:
        endpoint: nbg1.your-objectstorage.com
        accessKeyId: ${AWS_ACCESS_KEY_ID}
        secretAccessKey: ${AWS_SECRET_ACCESS_KEY}

  ingester:
    replicas: 3
    resources:
      requests:
        cpu: 100m
        memory: 512Mi
      limits:
        memory: 1Gi
    zoneAwareReplication:
      enabled: false
  querier:
    replicas: 2
    maxUnavailable: 1
    resources:
      requests:
        cpu: 200m
        memory: 128Mi
      limits:
        memory: 512Mi
  queryFrontend:
    replicas: 2
    maxUnavailable: 1
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        memory: 512Mi
  queryScheduler:
    replicas: 2
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        memory: 128Mi
  distributor:
    replicas: 2
    maxUnavailable: 1
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 512Mi
  compactor:
    replicas: 1
    resources:
      requests:
        cpu: 100m
        memory: 512Mi
      limits:
        memory: 2Gi
  indexGateway:
    replicas: 2
    maxUnavailable: 1
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        memory: 256Mi
  lokiCanary:
    kind: Deployment
    replicas: 1
    resources:
      requests:
        cpu: 25m
        memory: 32Mi
      limits:
        memory: 64Mi
  resultsCache:
    replicas: 1
    allocatedMemory: 250
    resources:
      requests:
        cpu: 100m
        memory: 300Mi
      limits:
        memory: 300Mi
  chunksCache:
    replicas: 1
    allocatedMemory: 2000
    resources:
      requests:
        cpu: 100m
        memory: 2500Mi
      limits:
        memory: 2500Mi
  gateway:
    replicas: 2
    resources:
      requests:
        cpu: 50m
        memory: 32Mi
      limits:
        memory: 128Mi
  patternIngester:
    replicas: 2
    maxUnavailable: 1
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 1Gi

  # Disable experimental components
  bloomPlanner:
    replicas: 0
  bloomBuilder:
    replicas: 0
  bloomGateway:
    replicas: 0

  # Disable components not used in this deployment mode
  backend:
    replicas: 0
  read:
    replicas: 0
  write:
    replicas: 0
  singleBinary:
    replicas: 0
