opentelemetry-collector:
  mode: daemonset

  image:
    repository: otel/opentelemetry-collector-contrib

  # NOT using hostNetwork - this runs in pod network (in mesh)
  hostNetwork: false

  # Enable service for DaemonSet mode (disabled by default)
  # Required for otel-receiver to forward logs to otel-shipper
  service:
    enabled: true

  # Run on all nodes including control plane
  tolerations:
    - key: "node-role.kubernetes.io/control-plane"
      operator: "Exists"
      effect: "NoSchedule"

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      memory: 256Mi

  # Enable pod log collection preset
  presets:
    logsCollection:
      enabled: true
      includeCollectorLogs: false
      storeCheckpoints: true

  # Configure ports
  ports:
    otlp:
      enabled: true
      containerPort: 4317
      servicePort: 4317
      protocol: TCP
    otlp-http:
      enabled: false
    jaeger-compact:
      enabled: false
    jaeger-thrift:
      enabled: false
    jaeger-grpc:
      enabled: false
    zipkin:
      enabled: false
    metrics:
      enabled: false

  # Collector configuration
  config:
    receivers:
      # Receive logs from otel-receiver
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317

    processors:
      batch:
        send_batch_size: 16384
        timeout: 5s

      memory_limiter:
        check_interval: 1s
        limit_mib: 200

      # Transform Talos logs to extract service.name from talos-service
      transform/talos:
        error_mode: ignore
        log_statements:
          - context: log
            statements:
              # Extract level
              - set(severity_text, attributes["talos-level"]) where attributes["talos-level"] != nil
              # Create service.name from talos-service (e.g., "machined" -> "talos-machined")
              - set(attributes["service.name"], Concat(["talos-", attributes["talos-service"]], "")) where attributes["talos-service"] != nil
              # Fallback for kernel logs
              - set(attributes["service.name"], "talos-kernel") where resource.attributes["log_type"] == "talos-kernel" and attributes["service.name"] == nil

      # Group logs by service.name to move it to resource attributes
      # This is required because Loki OTLP uses resource attributes for labels
      groupbyattrs/talos:
        keys:
          - service.name

      # Add Loki-specific attributes for pod logs
      attributes/loki:
        actions:
          - key: loki.attribute.labels
            value: host.name,k8s.namespace.name,k8s.pod.name,k8s.container.name
            action: insert

    exporters:
      # Send to Loki via OTLP
      otlphttp/loki:
        endpoint: "http://loki-gateway.loki.svc.cluster.local/otlp"
        headers:
          X-Scope-OrgID: "prod"

      # Debug exporter for troubleshooting
      debug:
        verbosity: detailed
        sampling_initial: 5
        sampling_thereafter: 200

    service:
      pipelines:
        # Pipeline for logs from otel-receiver (Talos logs)
        logs/talos:
          receivers: [otlp]
          processors: [memory_limiter, transform/talos, groupbyattrs/talos, batch]
          exporters: [otlphttp/loki, debug]

        # Pipeline for pod logs (from preset)
        logs:
          receivers: [filelog]
          processors: [memory_limiter, attributes/loki, batch]
          exporters: [otlphttp/loki]