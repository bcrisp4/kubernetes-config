opentelemetry-collector:
  mode: daemonset

  image:
    repository: otel/opentelemetry-collector-contrib

  # Required for receiving Talos host logs on localhost
  hostNetwork: true
  dnsPolicy: ClusterFirstWithHostNet

  # Run on all nodes including control plane
  tolerations:
    - key: "node-role.kubernetes.io/control-plane"
      operator: "Exists"
      effect: "NoSchedule"

  resources:
    requests:
      cpu: 100m
      memory: 32Mi
    limits:
      memory: 64Mi

  # Disable default ports we don't need
  ports:
    otlp:
      enabled: false
    otlp-http:
      enabled: false
    jaeger-compact:
      enabled: false
    jaeger-thrift:
      enabled: false
    jaeger-grpc:
      enabled: false
    zipkin:
      enabled: false
    metrics:
      enabled: false

  # Collector configuration
  config:
    receivers:
      # Talos service logs (JSON over TCP)
      tcplog/talos_service:
        listen_address: "127.0.0.1:6051"
        operators:
          - type: json_parser
            parse_from: body
            parse_to: attributes

      # Talos kernel logs (JSON over TCP)
      tcplog/talos_kernel:
        listen_address: "127.0.0.1:6050"
        operators:
          - type: json_parser
            parse_from: body
            parse_to: attributes

    processors:
      batch:
        send_batch_size: 8192
        timeout: 5s

      memory_limiter:
        check_interval: 1s
        limit_mib: 50

      # Add hostname and log type attributes
      resource/talos_service:
        attributes:
          - key: log_type
            value: talos-service
            action: insert

      resource/talos_kernel:
        attributes:
          - key: log_type
            value: talos-kernel
            action: insert

    exporters:
      # Forward to otel-shipper
      otlp:
        endpoint: "otel-shipper-opentelemetry-collector.otel-shipper.svc.cluster.local:4317"
        tls:
          insecure: true

    service:
      telemetry:
        logs:
          level: warn
      pipelines:
        logs/talos_service:
          receivers: [tcplog/talos_service]
          processors: [memory_limiter, resource/talos_service, batch]
          exporters: [otlp]

        logs/talos_kernel:
          receivers: [tcplog/talos_kernel]
          processors: [memory_limiter, resource/talos_kernel, batch]
          exporters: [otlp]
