alloy:
  crds:
    create: false
  alloy:
    configMap:
      create: true
      content: |-
        // Discover all pod log files
        local.file_match "pods" {
          path_targets = [{
            __path__ = "/var/log/pods/*/*/*.log",
          }]
        }

        // Discover pods for metadata enrichment
        discovery.kubernetes "pods" {
          role = "pod"
        }

        // Relabel to add pod metadata
        discovery.relabel "pod_logs" {
          targets = local.file_match.pods.targets

          // Extract namespace, pod name, UID, and container from the file path
          rule {
            source_labels = ["__path__"]
            regex         = "/var/log/pods/(?P<namespace>[^_]+)_(?P<pod>[^_]+)_(?P<uid>[^/]+)/(?P<container>[^/]+)/.*\\.log"
            target_label  = "namespace"
            replacement   = "$1"
          }

          rule {
            source_labels = ["__path__"]
            regex         = "/var/log/pods/(?P<namespace>[^_]+)_(?P<pod>[^_]+)_(?P<uid>[^/]+)/(?P<container>[^/]+)/.*\\.log"
            target_label  = "pod"
            replacement   = "$2"
          }

          rule {
            source_labels = ["__path__"]
            regex         = "/var/log/pods/(?P<namespace>[^_]+)_(?P<pod>[^_]+)_(?P<uid>[^/]+)/(?P<container>[^/]+)/.*\\.log"
            target_label  = "container"
            replacement   = "$4"
          }
        }

        // Read and parse the log files
        loki.source.file "pods" {
          targets    = discovery.relabel.pod_logs.output
          forward_to = [loki.write.default.receiver]
        }

        // Write logs to Loki
        loki.write "default" {
          endpoint {
            url = "http://loki-gateway.loki.svc.cluster.local/loki/api/v1/push"
            headers = {
              "X-Scope-OrgID" = "prod",
            }
          }
        }
    clustering:
      enabled: false
    mounts:
      varlog: true
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        memory: 256Mi
  controller:
    type: "daemonset"
    tolerations:
      - key: "node-role.kubernetes.io/control-plane"
        operator: "Exists"
        effect: "NoSchedule"
