alloy:
  crds:
    create: false
  alloy:
    stabilityLevel: "experimental"
    configMap:
      create: true
      content: |-
        // Discover all pod log files
        local.file_match "pods" {
          path_targets = [{
            __path__ = "/var/log/pods/*/*/*.log",
          }]
        }

        // Relabel to add pod metadata
        discovery.relabel "pod_logs" {
          targets = local.file_match.pods.targets

          // Extract namespace, pod name, UID, and container from the file path
          rule {
            source_labels = ["__path__"]
            regex         = "/var/log/pods/(?P<namespace>[^_]+)_(?P<pod>[^_]+)_(?P<uid>[^/]+)/(?P<container>[^/]+)/.*\\.log"
            target_label  = "namespace"
            replacement   = "$1"
          }

          rule {
            source_labels = ["__path__"]
            regex         = "/var/log/pods/(?P<namespace>[^_]+)_(?P<pod>[^_]+)_(?P<uid>[^/]+)/(?P<container>[^/]+)/.*\\.log"
            target_label  = "pod"
            replacement   = "$2"
          }

          rule {
            source_labels = ["__path__"]
            regex         = "/var/log/pods/(?P<namespace>[^_]+)_(?P<pod>[^_]+)_(?P<uid>[^/]+)/(?P<container>[^/]+)/.*\\.log"
            target_label  = "container"
            replacement   = "$4"
          }
        }

        // Read and parse the log files
        loki.source.file "pods" {
          targets    = discovery.relabel.pod_logs.output
          forward_to = [loki.write.default.receiver]
        }

        // Receive Talos service logs over TCP (JSON lines format)
        otelcol.receiver.tcplog "talos_service" {
          listen_address = "0.0.0.0:6051"
          add_attributes = true

          output {
            logs = [otelcol.processor.transform.talos_service.input]
          }
        }

        // Receive Talos kernel logs over TCP (JSON lines format)
        otelcol.receiver.tcplog "talos_kernel" {
          listen_address = "0.0.0.0:6050"
          add_attributes = true

          output {
            logs = [otelcol.processor.transform.talos_kernel.input]
          }
        }

        // Parse JSON from service logs and extract fields as attributes
        otelcol.processor.transform "talos_service" {
          error_mode = "ignore"

          log_statements {
            context = "log"
            statements = [
              // Parse body as JSON
              `merge_maps(cache, ParseJSON(body), "upsert") where IsMatch(body, "^\\{")`,
              // Extract fields as attributes
              `set(attributes["talos-service"], cache["talos-service"])`,
              `set(attributes["talos-level"], cache["talos-level"])`,
              `set(attributes["msg"], cache["msg"])`,
            ]
          }

          output {
            logs = [otelcol.processor.attributes.talos_service.input]
          }
        }

        // Parse JSON from kernel logs and extract fields as attributes
        otelcol.processor.transform "talos_kernel" {
          error_mode = "ignore"

          log_statements {
            context = "log"
            statements = [
              // Parse body as JSON
              `merge_maps(cache, ParseJSON(body), "upsert") where IsMatch(body, "^\\{")`,
              // Extract fields as attributes
              `set(attributes["facility"], cache["facility"])`,
              `set(attributes["talos-level"], cache["talos-level"])`,
              `set(attributes["msg"], cache["msg"])`,
            ]
          }

          output {
            logs = [otelcol.processor.attributes.talos_kernel.input]
          }
        }

        // Add labels for service logs
        otelcol.processor.attributes "talos_service" {
          action {
            key = "loki.attribute.labels"
            action = "insert"
            value = "talos-service, talos-level, host"
          }

          action {
            key = "loki.format"
            action = "insert"
            value = "json"
          }

          action {
            key = "job"
            action = "insert"
            value = "talos-service"
          }

          action {
            key = "host"
            action = "insert"
            value = env("HOSTNAME")
          }

          output {
            logs = [otelcol.exporter.loki.default.input]
          }
        }

        // Add labels for kernel logs
        otelcol.processor.attributes "talos_kernel" {
          action {
            key = "loki.attribute.labels"
            action = "insert"
            value = "facility, talos-level, host"
          }

          action {
            key = "loki.format"
            action = "insert"
            value = "json"
          }

          action {
            key = "job"
            action = "insert"
            value = "talos-kernel"
          }

          action {
            key = "host"
            action = "insert"
            value = env("HOSTNAME")
          }

          output {
            logs = [otelcol.exporter.loki.default.input]
          }
        }

        // Export OTEL logs to Loki format and forward to loki.write
        otelcol.exporter.loki "default" {
          forward_to = [loki.write.default.receiver]
        }

        // Write logs to Loki
        loki.write "default" {
          endpoint {
            url = "http://loki-gateway.loki.svc.cluster.local/loki/api/v1/push"
            headers = {
              "X-Scope-OrgID" = "prod",
            }
          }
        }
    clustering:
      enabled: false
    mounts:
      varlog: true
    enableHttpServerPort: true
    listenAddr: 0.0.0.0
    listenPort: 12345
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        memory: 256Mi
  controller:
    type: "daemonset"
    dnsPolicy: "ClusterFirstWithHostNet"
    hostNetwork: true
    tolerations:
      - key: "node-role.kubernetes.io/control-plane"
        operator: "Exists"
        effect: "NoSchedule"
