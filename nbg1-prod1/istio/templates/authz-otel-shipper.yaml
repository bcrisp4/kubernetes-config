# Authorization policy for otel-shipper
# Allows otel-receiver (hostNetwork, not in mesh) to push logs
#
# NOTE: Using ipBlocks (not remoteIpBlocks) because ztunnel only supports L4
# attributes. remoteIpBlocks requires HTTP header parsing (X-Forwarded-For).
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: otel-shipper
  namespace: otel-shipper
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: opentelemetry-collector
  action: ALLOW
  rules:
    # Allow otel-receiver to push logs (from pod network, not in mesh)
    - from:
        - source:
            ipBlocks: ["10.244.0.0/16"]
---
# PeerAuthentication for otel-shipper to accept plaintext from otel-receiver
# The mesh-wide STRICT mTLS policy blocks non-mesh traffic. otel-receiver
# runs in hostNetwork mode (outside the mesh) and cannot do mTLS.
apiVersion: security.istio.io/v1
kind: PeerAuthentication
metadata:
  name: otel-shipper
  namespace: otel-shipper
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: opentelemetry-collector
  mtls:
    mode: PERMISSIVE
